# Therapy Tutorials System Specification

## Access Control
- Route: `/therapy-tutorials`
- Access restricted to users with "therapist" or "admin" roles
- Unauthorized users redirected to home page (`/`)
- Therapist users automatically redirected here from home page

## Database Schema (Vercel KV)

### Books
```json
{
  "therapy-books": {
    "book:<uuid>": {
      "id": "uuid",
      "title": "string",
      "author": "string",
      "description": "string",
      "orderIndex": "number",
      "dateAdded": "ISO timestamp"
    }
  }
}
```

### Chapters
```json
{
  "therapy-chapters": {
    "chapter:<uuid>": {
      "id": "uuid",
      "bookId": "uuid",
      "title": "string",
      "content": "string",
      "orderIndex": "number",
      "dateAdded": "ISO timestamp"
    }
  }
}
```

## Key Features

### 1. Therapy Tutorials Main Interface
- Accordion-style layout showing books
- Each book expands to show chapters
- Clicking chapter initiates tutorial chat
- Books and chapters displayed in order based on orderIndex

### 2. Tutorial Chat Interface
- Uses existing chat interface component
- Special prompt template for therapy tutorials
- Combines chapter content with tutorial prompt
- Interactive learning experience

### 3. Admin Management Interface
- Protected route `/admin/therapy-books`
- Only accessible to admin role
- Features:
  - Add/edit/delete books
  - Add/edit/delete chapters
  - Reorder books and chapters
  - Rich text editor for chapter content

## API Endpoints

### Admin Routes
```typescript
POST /api/therapy-books
- Add new book
- Requires admin role

PUT /api/therapy-books/:id
- Update book
- Requires admin role

DELETE /api/therapy-books/:id
- Delete book
- Requires admin role

POST /api/therapy-chapters
- Add new chapter
- Requires admin role

PUT /api/therapy-chapters/:id
- Update chapter
- Requires admin role

DELETE /api/therapy-chapters/:id
- Delete chapter
- Requires admin role
```

### Protected Routes
```typescript
GET /api/therapy-books
- Get all books
- Requires therapist or admin role

GET /api/therapy-chapters/:bookId
- Get chapters for specific book
- Requires therapist or admin role

GET /api/therapy-chapters/content/:chapterId
- Get full chapter content
- Requires therapist or admin role
```

## Implementation Phases

1. Database Setup
   - Set up Vercel KV schemas
   - Create helper functions for book/chapter management

2. Access Control
   - Implement role checking with Clerk
   - Set up route protection
   - Configure home page redirect for therapists

3. Main Interface
   - Build accordion component
   - Implement book/chapter display
   - Connect to API endpoints

4. Admin Interface
   - Create admin management UI
   - Implement CRUD operations
   - Add rich text editor

5. Tutorial Chat Integration
   - Create therapy tutorial prompt template
   - Integrate with existing chat interface
   - Connect chapter content to chat system

6. Testing & Deployment
   - Test role-based access
   - Test CRUD operations
   - Test tutorial chat functionality
   - Deploy to production